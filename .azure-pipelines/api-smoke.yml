trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
      - release/*

pool:
  vmImage: "windows-latest"

variables:
  ENV: "qa"
  JUNIT_PATH: "test-results/junit.xml"
  DASHBOARD_OUT_DIR: "artifacts"

steps:
  - checkout: self
    clean: true

  - task: NodeTool@0
    inputs:
      versionSpec: "20.x"
    displayName: "Use Node 20"

  - script: |
      npm ci
    displayName: "Install dependencies"

  - script: |
      npx playwright install --with-deps
    displayName: "Install Playwright browsers"

  # Run tests and generate reports
  - script: |
      npx playwright test --reporter=junit,html
    displayName: "Run Playwright tests (JUnit + HTML)"
    env:
      ENV: $(ENV)

  # Build dashboard summary (writes artifacts/dashboard-summary.json)
  - script: |
      npm run dashboard:summary
    displayName: "Build dashboard summary"
    env:
      ENV: $(ENV)
      JUNIT_PATH: $(JUNIT_PATH)
      DASHBOARD_OUT_DIR: $(DASHBOARD_OUT_DIR)

  # Publish JUnit into Azure DevOps "Tests" tab
  - task: PublishTestResults@2
    displayName: "Publish JUnit test results"
    inputs:
      testResultsFormat: "JUnit"
      testResultsFiles: "**/test-results/junit.xml"
      failTaskOnFailedTests: true
      testRunTitle: "EnvShift Smoke ($(ENV))"

  # Publish dashboard artifact
  - task: PublishPipelineArtifact@1
    displayName: "Publish dashboard artifacts"
    inputs:
      targetPath: "$(System.DefaultWorkingDirectory)/artifacts"
      artifact: "dashboard"
      publishLocation: "pipeline"

  # Publish Playwright HTML report
  - task: PublishPipelineArtifact@1
    displayName: "Publish Playwright HTML report"
    inputs:
      targetPath: "$(System.DefaultWorkingDirectory)/playwright-report"
      artifact: "playwright-report"
      publishLocation: "pipeline"

      